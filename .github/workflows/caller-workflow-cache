name: caller-workflow-cache

on:
  workflow_dispatch
  # push:
  #   branches:
  #     - main
  # pull_request:

jobs:
  compile:
    runs-on: ubuntu-latest
    outputs:
      build-cache-key: ${{ steps.set-cache-key.outputs.key }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate cache key
        id: set-cache-key
        run: echo "key=build-${{ runner.os }}-${{ hashFiles('src/**/*.c', 'src/**/*.h') }}" >> $GITHUB_OUTPUT

      - name: Compile C Code
        uses: MyDummyorg159/actions-repo/.github/actions/compile@main
        with:
          c_file: "src/sample.c"

      - name: Save compiled build to cache
        uses: actions/cache/save@v4
        with:
          path: build/
          key: ${{ steps.set-cache-key.outputs.key }}

  static-analysis:
    runs-on: ubuntu-latest
    needs: compile
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Restore build output from compile job
        uses: actions/cache@v4
        with:
          path: build/
          key: ${{ needs.compile.outputs.build-cache-key }}
          restore-keys: |
            build-${{ runner.os }}-

      - name: Static Code Analysis
        uses: MyDummyorg159/actions-repo/.github/actions/static-analysis@main
        with:
          c_file: "src/sample.c"
